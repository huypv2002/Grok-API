name: Build Windows EXE

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: 'dev'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          
          # Install PySide6 first
          pip install PySide6==6.6.0
          
          # Install main dependencies
          pip install httpx httpcore certifi anyio sniffio h11
          pip install requests pydantic cryptography
          pip install selenium undetected-chromedriver
          pip install zendriver
          
          # Install Nuitka
          pip install nuitka ordered-set zstandard
          
          # Verify installations
          python -c "import PySide6; print('PySide6:', PySide6.__version__)"
          python -c "import httpx; print('httpx OK')"
          python -c "import cryptography; print('cryptography OK')"
          python -c "import selenium; print('selenium OK')"
          python -c "import zendriver; print('zendriver OK')"
      
      - name: Build with Nuitka
        run: |
          python -m nuitka `
            --standalone `
            --onefile `
            --windows-console-mode=disable `
            --output-filename=GrokVideoGenerator.exe `
            --enable-plugin=pyside6 `
            --enable-plugin=anti-bloat `
            --include-package=src `
            --include-package=src.core `
            --include-package=src.gui `
            --include-package=src.utils `
            --include-package=httpx `
            --include-package=httpcore `
            --include-package=certifi `
            --include-package=anyio `
            --include-package=sniffio `
            --include-package=h11 `
            --include-package=requests `
            --include-package=pydantic `
            --include-package=cryptography `
            --include-package=selenium `
            --include-package=selenium.webdriver `
            --include-package=undetected_chromedriver `
            --include-package=zendriver `
            --include-package=zendriver.core `
            --include-package=zendriver.cdp `
            --include-package=websockets `
            --include-package-data=PySide6 `
            --include-package-data=requests `
            --include-package-data=cryptography `
            --include-package-data=pydantic `
            --include-package-data=certifi `
            --include-package-data=httpx `
            --include-package-data=zendriver `
            --include-data-dir=src=src `
            --nofollow-import-to=tkinter `
            --nofollow-import-to=_tkinter `
            --nofollow-import-to=tkinter.* `
            --nofollow-import-to=PyQt6 `
            --nofollow-import-to=PyQt5 `
            --nofollow-import-to=PyQt4 `
            --nofollow-import-to=PySide2 `
            --nofollow-import-to=matplotlib `
            --nofollow-import-to=numpy `
            --nofollow-import-to=pandas `
            --nofollow-import-to=scipy `
            --nofollow-import-to=IPython `
            --nofollow-import-to=jupyter `
            --nofollow-import-to=wx `
            --nofollow-import-to=kivy `
            --no-pyi-file `
            --assume-yes-for-downloads `
            --show-progress `
            main.py
      
      - name: Verify output
        run: |
          dir GrokVideoGenerator.exe
          echo "Build successful!"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: GrokVideoGenerator-windows
          path: GrokVideoGenerator.exe
          retention-days: 30
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: GrokVideoGenerator.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
