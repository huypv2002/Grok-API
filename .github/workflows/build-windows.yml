name: Build Windows EXE

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: 'dev'

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      # ── Cache 1: pip packages (download cache) ──
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: pip-win-py313-${{ hashFiles('requirements.txt') }}
          restore-keys: pip-win-py313-

      # ── Cache 2: Nuitka compilation cache (BIGGEST win) ──
      # Nuitka uses ccache internally — caching this dir skips recompiling
      # unchanged C files, saving 50-70% of build time on repeat builds.
      - name: Cache Nuitka ccache
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}\nuitka-cache
          key: nuitka-cache-win-py313-${{ hashFiles('main.py', 'src/**/*.py') }}
          restore-keys: |
            nuitka-cache-win-py313-

      # ── Cache 3: Nuitka downloads (MinGW64 C compiler, ~400MB) ──
      # Nuitka auto-downloads MinGW64 on Windows if no MSVC found.
      # Caching this avoids re-downloading every build.
      - name: Cache Nuitka AppData (MinGW64 + tools)
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\Nuitka
          key: nuitka-appdata-win-v2
          restore-keys: nuitka-appdata-win-

      # ── Cache 4: Installed Python packages (site-packages) ──
      # Avoids re-installing all wheels when requirements.txt hasn't changed.
      - name: Get Python site-packages path
        id: site_pkg
        run: |
          $sp = (python -c "import site; print(site.getsitepackages()[0])").Trim()
          echo "SITE_PACKAGES=$sp" >> $env:GITHUB_OUTPUT
          echo "site-packages: $sp"

      - name: Cache site-packages
        id: cache_site
        uses: actions/cache@v4
        with:
          path: ${{ steps.site_pkg.outputs.SITE_PACKAGES }}
          key: site-pkg-win-py313-${{ hashFiles('requirements.txt') }}-v2
          restore-keys: site-pkg-win-py313-

      - name: Install dependencies
        run: |
          pip install --upgrade pip wheel setuptools

          # Only full install if cache miss
          pip install -r requirements.txt

          # Sub-dependencies needed for Nuitka bundling
          pip install httpcore certifi anyio sniffio h11 idna
          pip install urllib3 charset-normalizer
          pip install cffi pycparser
          pip install chromedriver-autoinstaller

          # Build tools
          pip install nuitka ordered-set zstandard

      - name: Prepare package data paths
        id: pkg_paths
        run: |
          $raw = (python -c "import grapheme, os; print(os.path.dirname(grapheme.__file__))").Trim()
          $grapheme_dir = $raw -replace '\\', '/'
          echo "GRAPHEME_DIR=$grapheme_dir" >> $env:GITHUB_OUTPUT

          $data_dir = Join-Path $raw "data"
          if (-not (Test-Path $data_dir)) {
            echo "ERROR: grapheme/data NOT found"
            exit 1
          }
          echo "OK: grapheme/data found"

          $cpu = $env:NUMBER_OF_PROCESSORS
          if (-not $cpu) { $cpu = "4" }
          echo "CPU_COUNT=$cpu" >> $env:GITHUB_OUTPUT
          echo "CPU cores: $cpu"

      - name: Build with Nuitka
        env:
          NUITKA_CACHE_DIR: ${{ runner.temp }}\nuitka-cache
        run: |
          $grapheme_dir = "${{ steps.pkg_paths.outputs.GRAPHEME_DIR }}"
          $cpu = "${{ steps.pkg_paths.outputs.CPU_COUNT }}"

          # Create cache dir if not exists
          New-Item -ItemType Directory -Force -Path $env:NUITKA_CACHE_DIR | Out-Null

          echo "Building with $cpu jobs, cache=$env:NUITKA_CACHE_DIR"
          echo "Start: $(Get-Date -Format 'HH:mm:ss')"

          python -m nuitka `
            --standalone `
            --onefile `
            --windows-console-mode=attach `
            --output-filename=GrokVideoGenerator.exe `
            --enable-plugin=pyside6 `
            --jobs=$cpu `
            --cache-dir="$env:NUITKA_CACHE_DIR" `
            --include-package=src `
            --include-package=src.core `
            --include-package=src.gui `
            --include-package=src.utils `
            --include-package=httpx `
            --include-package=httpcore `
            --include-package=anyio `
            --include-package=anyio._backends `
            --include-package=requests `
            --include-package=urllib3 `
            --include-package=charset_normalizer `
            --include-package=pydantic `
            --include-package=cryptography `
            --include-package=cryptography.hazmat `
            --include-package=cryptography.hazmat.primitives `
            --include-package=cryptography.hazmat.backends `
            --include-package=selenium `
            --include-package=selenium.webdriver `
            --include-package=undetected_chromedriver `
            --include-package=chromedriver_autoinstaller `
            --include-package=setuptools `
            --include-package=setuptools._distutils `
            --include-package=setuptools._distutils.version `
            --include-package=zendriver `
            --include-package=zendriver.core `
            --include-package=zendriver.cdp `
            --include-package=websockets `
            --include-package=emoji `
            --include-package=grapheme `
            --include-package=latest_user_agents `
            --include-package=user_agents `
            --include-module=_cffi_backend `
            --include-module=sqlite3 `
            --include-module=ctypes `
            --include-module=winreg `
            --include-package-data=PySide6 `
            --include-package-data=certifi `
            --include-package-data=cryptography `
            --include-package-data=pydantic `
            --include-package-data=zendriver `
            --include-package-data=emoji `
            --include-package-data=grapheme `
            --include-package-data=selenium `
            --include-package-data=undetected_chromedriver `
            --include-package-data=setuptools `
            --include-package-data=latest_user_agents `
            --include-package-data=user_agents `
            --include-package-data=chromedriver_autoinstaller `
            --include-data-dir="$grapheme_dir/data=grapheme/data" `
            --nofollow-import-to=tkinter `
            --nofollow-import-to=_tkinter `
            --nofollow-import-to=PyQt6 `
            --nofollow-import-to=PyQt5 `
            --nofollow-import-to=PySide2 `
            --nofollow-import-to=matplotlib `
            --nofollow-import-to=numpy `
            --nofollow-import-to=pandas `
            --nofollow-import-to=scipy `
            --nofollow-import-to=IPython `
            --nofollow-import-to=jupyter `
            --nofollow-import-to=wx `
            --nofollow-import-to=kivy `
            --nofollow-import-to=test `
            --nofollow-import-to=unittest `
            --nofollow-import-to=doctest `
            --no-pyi-file `
            --assume-yes-for-downloads `
            main.py

          echo "End: $(Get-Date -Format 'HH:mm:ss')"

      - name: Verify output
        run: |
          if (Test-Path "GrokVideoGenerator.exe") {
            $size = (Get-Item "GrokVideoGenerator.exe").Length
            $sizeMB = [math]::Round($size / 1MB, 2)
            echo "Build successful! Size: ${sizeMB} MB"
          } else {
            echo "ERROR: GrokVideoGenerator.exe not found!"
            Get-ChildItem -Recurse -Filter "GrokVideoGenerator.exe" | ForEach-Object { echo $_.FullName }
            exit 1
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: GrokVideoGenerator-windows
          path: GrokVideoGenerator.exe
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: GrokVideoGenerator.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
