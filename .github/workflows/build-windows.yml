name: Build Windows EXE

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: 'dev'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: pip-win-py313-${{ hashFiles('requirements.txt') }}
          restore-keys: pip-win-py313-

      - name: Cache Nuitka compilation
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\Nuitka\Nuitka\Cache
          key: nuitka-win-py313-${{ hashFiles('main.py', 'src/**/*.py', 'requirements.txt') }}
          restore-keys: |
            nuitka-win-py313-
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip wheel setuptools
          pip install -r requirements.txt
          pip install nuitka ordered-set zstandard
      
      - name: Verify third-party imports
        run: |
          python -c "
          import sys
          print(f'Python {sys.version}')
          errors = []
          modules = [
              'PySide6', 'PySide6.QtWidgets', 'PySide6.QtCore', 'PySide6.QtGui',
              'PySide6.QtMultimedia', 'PySide6.QtMultimediaWidgets',
              'httpx', 'curl_cffi', 'cryptography', 'cryptography.fernet',
              'pydantic', 'selenium', 'undetected_chromedriver',
              'zendriver', 'websockets', 'emoji', 'grapheme',
              'latest_user_agents', 'user_agents', 'requests',
              'setuptools', '_cffi_backend',
          ]
          for mod in modules:
              try:
                  __import__(mod)
                  print(f'  OK: {mod}')
              except ImportError as e:
                  print(f'  FAIL: {mod} -> {e}')
                  errors.append(f'{mod}: {e}')
          if errors:
              print(f'\n=== {len(errors)} MISSING MODULES ===')
              for e in errors:
                  print(f'  {e}')
              sys.exit(1)
          print(f'\nAll {len(modules)} modules OK!')
          "
      - name: Prepare package data paths
        id: pkg_paths
        run: |
          # Get curl_cffi dir (contains native .dll libs needed for --include-data-dir)
          $curl_raw = (python -c "import curl_cffi, os; print(os.path.dirname(curl_cffi.__file__))").Trim()
          $curl_dir = $curl_raw -replace '\\', '/'
          echo "CURL_CFFI_DIR=$curl_dir" >> $env:GITHUB_OUTPUT
          echo "curl_cffi dir: $curl_dir"
          # Get CPU count
          $cpu = $env:NUMBER_OF_PROCESSORS
          if (-not $cpu) { $cpu = "4" }
          echo "CPU_COUNT=$cpu" >> $env:GITHUB_OUTPUT
          echo "CPU cores: $cpu"
      - name: Build with Nuitka
        run: |
          $curl_cffi_dir = "${{ steps.pkg_paths.outputs.CURL_CFFI_DIR }}"
          $cpu = "${{ steps.pkg_paths.outputs.CPU_COUNT }}"
          echo "Building with $cpu jobs..."
          python -m nuitka `
            --standalone `
            --onefile `
            --windows-console-mode=force `
            --output-filename=GrokVideoGenerator.exe `
            --enable-plugin=pyside6 `
            --jobs=$cpu `
            --lto=no `
            --include-package=src `
            --include-package=httpx `
            --include-package=httpcore `
            --include-package=anyio `
            --include-package=requests `
            --include-package=urllib3 `
            --include-package=charset_normalizer `
            --include-package=curl_cffi `
            --include-package=pydantic `
            --include-package=cryptography `
            --include-package=selenium `
            --include-package=undetected_chromedriver `
            --include-package=chromedriver_autoinstaller `
            --include-package=setuptools `
            --include-package=zendriver `
            --include-package=websockets `
            --include-package=emoji `
            --include-package=grapheme `
            --include-package=latest_user_agents `
            --include-package=user_agents `
            --include-module=_cffi_backend `
            --include-module=PySide6.QtMultimedia `
            --include-module=PySide6.QtMultimediaWidgets `
            --include-package-data=PySide6 `
            --include-package-data=certifi `
            --include-package-data=cryptography `
            --include-package-data=pydantic `
            --include-package-data=zendriver `
            --include-package-data=emoji `
            --include-package-data=grapheme `
            --include-package-data=curl_cffi `
            --include-package-data=selenium `
            --include-package-data=undetected_chromedriver `
            --include-package-data=setuptools `
            --include-package-data=latest_user_agents `
            --include-package-data=user_agents `
            --include-package-data=chromedriver_autoinstaller `
            --include-data-dir="$curl_cffi_dir=curl_cffi" `
            --nofollow-import-to=tkinter `
            --nofollow-import-to=_tkinter `
            --nofollow-import-to=PyQt6 `
            --nofollow-import-to=PyQt5 `
            --nofollow-import-to=PySide2 `
            --nofollow-import-to=matplotlib `
            --nofollow-import-to=numpy `
            --nofollow-import-to=pandas `
            --nofollow-import-to=scipy `
            --nofollow-import-to=IPython `
            --nofollow-import-to=jupyter `
            --nofollow-import-to=wx `
            --nofollow-import-to=kivy `
            --nofollow-import-to=test `
            --nofollow-import-to=unittest `
            --nofollow-import-to=doctest `
            --nofollow-import-to=giaima `
            --no-pyi-file `
            --assume-yes-for-downloads `
            main.py
      - name: Verify output
        run: |
          if (Test-Path "GrokVideoGenerator.exe") {
            $size = (Get-Item "GrokVideoGenerator.exe").Length
            $sizeMB = [math]::Round($size / 1MB, 2)
            echo "Build successful! Size: ${sizeMB} MB"
          } else {
            echo "ERROR: GrokVideoGenerator.exe not found!"
            Get-ChildItem -Recurse -Filter "GrokVideoGenerator.exe" | ForEach-Object { echo $_.FullName }
            exit 1
          }

      - name: Smoke test - check exe starts
        run: |
          echo "=== Smoke test: run exe with timeout ==="
          $proc = Start-Process -FilePath ".\GrokVideoGenerator.exe" -PassThru -NoNewWindow
          echo "PID: $($proc.Id)"
          Start-Sleep -Seconds 10
          
          # Check if process is still running (good) or crashed immediately (bad)
          if ($proc.HasExited) {
            echo "WARN: Process exited with code $($proc.ExitCode)"
            # Check for crash log
            if (Test-Path "crash.log") {
              echo "=== crash.log ==="
              Get-Content "crash.log"
            }
            if (Test-Path "debug_startup.log") {
              echo "=== debug_startup.log ==="
              Get-Content "debug_startup.log"
            }
            # Check LOCALAPPDATA fallback
            $fallback = "$env:LOCALAPPDATA\GrokVideoGenerator"
            if (Test-Path $fallback) {
              echo "=== Fallback dir found: $fallback ==="
              Get-ChildItem -Recurse $fallback | ForEach-Object { echo $_.FullName }
            }
            # Check Desktop
            $desktop = [Environment]::GetFolderPath("Desktop")
            if (Test-Path "$desktop\grok_debug.log") {
              echo "=== Desktop grok_debug.log ==="
              Get-Content "$desktop\grok_debug.log"
            }
          } else {
            echo "OK: Process is running (PID $($proc.Id))"
            # Check created files
            if (Test-Path "data") {
              echo "=== data/ folder found cáº¡nh exe ==="
              Get-ChildItem "data" | ForEach-Object { echo "  $($_.Name)" }
            }
            if (Test-Path "debug_startup.log") {
              echo "=== debug_startup.log ==="
              Get-Content "debug_startup.log"
            }
            $fallback = "$env:LOCALAPPDATA\GrokVideoGenerator"
            if (Test-Path $fallback) {
              echo "=== Fallback dir: $fallback ==="
              Get-ChildItem -Recurse $fallback | ForEach-Object { echo $_.FullName }
            }
            Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
          }
          echo "=== Smoke test done ==="
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: GrokVideoGenerator-windows
          path: GrokVideoGenerator.exe
          retention-days: 30
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: GrokVideoGenerator.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}