name: Build Windows EXE

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: 'dev'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install zendriver
          pip install pyinstaller
      
      - name: Build EXE with PyInstaller
        run: |
          $iconArg = ""
          if (Test-Path "assets/icon.ico") {
            $iconArg = "--icon=assets/icon.ico"
          }
          
          pyinstaller --noconfirm --onefile --windowed `
            --name "GrokVideoGenerator" `
            $iconArg `
            --add-data "src;src" `
            --hidden-import "PySide6.QtCore" `
            --hidden-import "PySide6.QtGui" `
            --hidden-import "PySide6.QtWidgets" `
            --hidden-import "httpx" `
            --hidden-import "cryptography" `
            --hidden-import "selenium" `
            --hidden-import "undetected_chromedriver" `
            --hidden-import "zendriver" `
            --collect-all "zendriver" `
            --collect-all "PySide6" `
            main.py
        shell: pwsh
      
      - name: Create data folders
        run: |
          mkdir dist\data
          mkdir dist\output
          echo {} > dist\data\accounts.json
          echo {} > dist\data\settings.json
      
      - name: Get version
        id: version
        run: |
          if ("${{ github.event.inputs.version }}" -ne "") {
            echo "VERSION=${{ github.event.inputs.version }}" >> $env:GITHUB_OUTPUT
          } elseif ("${{ github.ref_type }}" -eq "tag") {
            echo "VERSION=${{ github.ref_name }}" >> $env:GITHUB_OUTPUT
          } else {
            echo "VERSION=dev-${{ github.sha }}" >> $env:GITHUB_OUTPUT
          }
        shell: pwsh
      
      - name: Create ZIP package
        run: |
          Compress-Archive -Path dist\* -DestinationPath GrokVideoGenerator-${{ steps.version.outputs.VERSION }}-windows.zip
        shell: pwsh
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: GrokVideoGenerator-${{ steps.version.outputs.VERSION }}-windows
          path: GrokVideoGenerator-${{ steps.version.outputs.VERSION }}-windows.zip
          retention-days: 30
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: GrokVideoGenerator-${{ steps.version.outputs.VERSION }}-windows.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
